<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Financiero - Dashboard Asesor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f7fa;
            margin: 0;
            padding: 0;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-left h1 {
            font-size: 24px;
            margin: 0 0 5px 0;
        }

        .header-left p {
            opacity: 0.9;
            font-size: 14px;
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            text-align: right;
        }

        .user-info strong {
            font-size: 16px;
        }

        .user-info small {
            opacity: 0.8;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            cursor: pointer;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .metric-card .metric-icon {
            font-size: 30px;
            margin-bottom: 15px;
        }

        .metric-card .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .metric-card .metric-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .metric-card .metric-change {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
            background: #d4edda;
            color: #155724;
        }

        .content-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .section-header {
            padding: 25px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .filters {
            padding: 20px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active:hover {
            color: white;
        }

        .leads-list {
            padding: 0;
        }

        .lead-item {
            padding: 20px 30px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lead-item:hover {
            background: #f8f9fa;
        }

        .lead-item:last-child {
            border-bottom: none;
        }

        .lead-info {
            flex: 1;
        }

        .lead-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .lead-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .lead-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #888;
        }

        .lead-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-nuevos { background: #e3f2fd; color: #1976d2; }
        .status-interesado { background: #fff3e0; color: #f57c00; }
        .status-gestionando { background: #f3e5f5; color: #7b1fa2; }
        .status-cerrados { background: #e8f5e8; color: #2e7d32; }
        .status-pendiente { background: #f5f5f5; color: #666; }

        .action-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .action-btn:hover {
            background: #f5f5f5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #333;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            // Event listener para el formulario de edición
            const formEditar = document.getElementById('formEditarLead');
            if (formEditar) {
            formEditar.addEventListener('submit', function(e) {
    e.preventDefault();
    
    console.log('✏️ Procesando edición de lead...');
    
    // Obtener datos del formulario usando los IDs correctos del HTML
    const datosLead = {
        id: document.getElementById('editar-id').value,
        nombre: document.getElementById('editar-nombre').value.trim(),
        telefono: document.getElementById('editar-telefono').value.trim(),
        email: document.getElementById('editar-email').value.trim(),
        monto: document.getElementById('editar-monto').value,
        estado: document.getElementById('editar-estado').value,
        plan: document.getElementById('editar-plan').value,
        fechaCita: document.getElementById('editar-fecha-cita').value,
        horaCita: document.getElementById('editar-hora-cita').value,
        lugarCita: document.getElementById('editar-lugar-cita').value,
        observaciones: document.getElementById('editar-observaciones').value.trim()
    };
    
    console.log('📋 Datos de edición recopilados:', datosLead);
    
    // Validar campos requeridos
    if (!datosLead.nombre || !datosLead.telefono || !datosLead.monto) {
        alert('⚠️ Por favor complete todos los campos requeridos');
        return;
    }
    
    // Validar monto
    if (parseInt(datosLead.monto) < 1000) {
        alert('⚠️ El monto mínimo es $1,000');
        return;
    }
    
    console.log('✅ Datos validados, actualizando lead...');
    
    // USAR MÉTODO JSONP QUE FUNCIONA (como "Nuevo Lead")
    const callbackName = 'updateLead_' + Date.now();
    window[callbackName] = function(response) {
        console.log('📡 Respuesta actualizar:', response);
        
        if (response.success) {
            alert(`✅ ¡Lead actualizado exitosamente!\n\nCliente: ${datosLead.nombre}\nEstado: ${datosLead.estado}\nMonto: $${parseInt(datosLead.monto).toLocaleString()}`);
            
            // Cerrar modal
            cerrarModalEditar();
            
            // Recargar leads automáticamente
            cargarLeadsDesdeAPI();
        } else {
            alert(`❌ Error actualizando lead: ${response.message}`);
        }
        
        delete window[callbackName];
    };
    
    // Construir parámetros JSONP
    const params = new URLSearchParams({
        action: 'updateLead',
        callback: callbackName,
        'ID_Lead': datosLead.id,
        'Nombre_Cliente': datosLead.nombre,
        'Email': datosLead.email || '',
        'Telefono': datosLead.telefono,
        'Tipo_Credito': datosLead.plan,
        'Monto_Solicitado': datosLead.monto,
        'Estado': datosLead.estado,
        'Asesor_ID': usuarioActual.usuario,
        'Fecha de la cita': datosLead.fechaCita || '',
        'Hora de la cita': datosLead.horaCita || '',
        'Lugar de la cita': datosLead.lugarCita || '',
        'Observaciones': datosLead.observaciones || ''
    });
    
    // Usar EXACTAMENTE el mismo método que "Nuevo Lead"
    const script = document.createElement('script');
    script.src = `${API_URL}?${params.toString()}`;
    document.head.appendChild(script);
    
    console.log('🎉 Solicitud JSONP enviada');
});
            }

            .main-container {
                padding: 20px;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .lead-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .lead-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <h1>💼 CRM Financiero</h1>
            <p id="welcome-message">¡Bienvenido, Asesor!</p>
        <!-- Modal Editar Lead -->
        <div id="modalEditarLead" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">✏️ Editar Lead</h3>
                    <span class="close" onclick="cerrarModalEditar()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="formEditarLead">
                        <input type="hidden" id="editar-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>👤 Nombre Completo</label>
                                <input type="text" id="editar-nombre" required>
                            </div>
                            <div class="form-group">
                                <label>📱 Teléfono</label>
                                <input type="tel" id="editar-telefono" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>📧 Email</label>
                            <input type="email" id="editar-email">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>💰 Monto Solicitado</label>
                                <input type="number" id="editar-monto" min="1000" step="1000" required>
                            </div>
                            <div class="form-group">
                                <label>📊 Estado</label>
                                <select id="editar-estado" required>
                                    <option value="NUEVOS">🆕 NUEVOS</option>
                                    <option value="INTERESADO">👀 INTERESADO</option>
                                    <option value="GESTIONANDO">🔄 GESTIONANDO</option>
                                    <option value="CALIENTE">🔥 CALIENTE</option>
                                    <option value="REAGENDO">📅 REAGENDO</option>
                                    <option value="PERDIDO">❌ PERDIDO</option>
                                    <option value="INCONTACTABLE">📵 INCONTACTABLE</option>
                                    <option value="NO CONTESTA">🔇 NO CONTESTA</option>
                                    <option value="VOLVER A LLAMAR">📞 VOLVER A LLAMAR</option>
                                    <option value="CERRADOS">✅ CERRADO</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>💳 Tipo de Crédito</label>
                            <select id="editar-plan" required>
                                <option value="PERSONAL">💼 PERSONAL</option>
                                <option value="COMERCIAL">🏢 COMERCIAL</option>
                                <option value="HIPOTECARIO">🏠 HIPOTECARIO</option>
                                <option value="VEHICULAR">🚗 VEHICULAR</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>📅 Fecha de Cita</label>
                                <input type="date" id="editar-fecha-cita">
                            </div>
                            <div class="form-group">
                                <label>⏰ Hora de Cita</label>
                                <input type="time" id="editar-hora-cita">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>📍 Lugar de Cita</label>
                                  <input 
                                    type="text" 
                                    id="editar-lugar-cita" 
                                    placeholder="Ej: Oficina Central, Casa del cliente, CC El Jardín..."
                                    maxlength="100"
                                  >
                        </div>
                        
                        <div class="form-group">
                            <label>📝 Observaciones</label>
                            <textarea id="editar-observaciones" rows="3" placeholder="Notas sobre el cliente..."></textarea>
                        </div>
                        
                        <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="cerrarModalEditar()">
                                Cancelar
                            </button>
                            <button type="button" class="btn btn-primary" onclick="procesarEdicionLead()">
                                💾 Actualizar Lead
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="header-right">
            <div class="user-info">
                <strong id="user-name">Asesor</strong>
                <br>
                <small id="user-role">Cargando...</small>
            </div>
            <button class="logout-btn" onclick="cerrarSesion()">
                🚪 Cerrar Sesión
            </button>
        </div>
    </header>

    <div class="main-container">
        <!-- Métricas -->
        <div class="metrics-grid">
            <div class="metric-card" onclick="filtrarLeads('TODOS')">
                <div class="metric-icon">📊</div>
                <div class="metric-value" id="leads-activos">0</div>
                <div class="metric-label">Leads Activos</div>
                <div class="metric-change">+12% vs mes anterior</div>
            </div>
            
            <div class="metric-card" onclick="filtrarLeads('CERRADOS')">
                <div class="metric-icon">✅</div>
                <div class="metric-value" id="leads-cerrados">0</div>
                <div class="metric-label">Cerrados</div>
                <div class="metric-change">+8% vs mes anterior</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">💰</div>
                <div class="metric-value" id="pipeline-total">$0</div>
                <div class="metric-label">Pipeline Total</div>
                <div class="metric-change">+15% vs mes anterior</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">🎯</div>
                <div class="metric-value" id="tasa-conversion">0%</div>
                <div class="metric-label">Tasa Conversión</div>
                <div class="metric-change">+5% vs mes anterior</div>
            </div>
        </div>

        <!-- Lista de Leads -->
        <div class="content-section">
            <div class="section-header">
                <h2 class="section-title">📋 Mis Leads</h2>
                <div class="section-actions">
                    <button class="btn btn-secondary" onclick="recargarLeads()" style="margin-right: 10px;">
                        🔄 Actualizar
                    </button>
                    <button class="btn btn-primary" onclick="crearNuevoLead()">
                        ➕ Nuevo Lead
                    </button>
                </div>
            </div>

            <div class="filters">
                <button class="filter-btn active" onclick="filtrarLeads('TODOS')">TODOS</button>
                <button class="filter-btn" onclick="filtrarLeads('NUEVOS')">NUEVOS</button>
                <button class="filter-btn" onclick="filtrarLeads('INTERESADO')">INTERESADO</button>
                <button class="filter-btn" onclick="filtrarLeads('GESTIONANDO')">GESTIONANDO</button>
                <button class="filter-btn" onclick="filtrarLeads('CALIENTE')">CALIENTE</button>
                <button class="filter-btn" onclick="filtrarLeads('REAGENDO')">REAGENDO</button>
                <button class="filter-btn" onclick="filtrarLeads('PERDIDO')">PERDIDO</button>
                <button class="filter-btn" onclick="filtrarLeads('INCONTACTABLE')">INCONTACTABLE</button>
                <button class="filter-btn" onclick="filtrarLeads('NO CONTESTA')">NO CONTESTA</button>
                <button class="filter-btn" onclick="filtrarLeads('VOLVER A LLAMAR')">VOLVER A LLAMAR</button>
            </div>

            <div class="leads-list" id="leads-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>Cargando leads...</h3>
                    <p>Conectando con Google Sheets...</p>
                </div>
            </div>
        <!-- Modal Nuevo Lead -->
        <div id="modalNuevoLead" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">➕ Crear Nuevo Lead</h3>
                    <span class="close" onclick="cerrarModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="formNuevoLead">
                        <div class="form-row">
                            <div class="form-group">
                                <label>👤 Nombre Completo</label>
                                <input type="text" id="nuevo-nombre" required>
                            </div>
                            <div class="form-group">
                                <label>📱 Teléfono</label>
                                <input type="tel" id="nuevo-telefono" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>📧 Email</label>
                            <input type="email" id="nuevo-email">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>💰 Monto Solicitado</label>
                                <input type="number" id="nuevo-monto" min="1000" step="1000" placeholder="25000" required>
                            </div>
                            <div class="form-group">
                                <label>📊 Estado</label>
                                <select id="nuevo-estado" required>
                                    <option value="NUEVOS">🆕 NUEVOS</option>
                                    <option value="INTERESADO">👀 INTERESADO</option>
                                    <option value="GESTIONANDO">🔄 GESTIONANDO</option>
                                    <option value="CALIENTE">🔥 CALIENTE</option>
                                    <option value="REAGENDO">📅 REAGENDO</option>
                                    <option value="PERDIDO">❌ PERDIDO</option>
                                    <option value="INCONTACTABLE">📵 INCONTACTABLE</option>
                                    <option value="NO CONTESTA">🔇 NO CONTESTA</option>
                                    <option value="VOLVER A LLAMAR">📞 VOLVER A LLAMAR</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>💳 Tipo de Crédito</label>
                            <select id="nuevo-plan" required>
                                <option value="PERSONAL">💼 PERSONAL</option>
                                <option value="COMERCIAL">🏢 COMERCIAL</option>
                                <option value="HIPOTECARIO">🏠 HIPOTECARIO</option>
                                <option value="VEHICULAR">🚗 VEHICULAR</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>📅 Fecha de Cita</label>
                                <input type="date" id="nuevo-fecha-cita">
                            </div>
                            <div class="form-group">
                                <label>⏰ Hora de Cita</label>
                                <input type="time" id="nuevo-hora-cita">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>📍 Lugar de Cita</label>
                            <input
                                type="text" 
                                id="nuevo-lugar-cita" 
                                placeholder="Ej: Oficina Central, Casa del cliente, CC El Jardín..."
                                maxlength="100"
                            >
                        </div>
                        
                        <div class="form-group">
                            <label>📝 Observaciones</label>
                            <textarea id="nuevo-observaciones" rows="3" placeholder="Notas sobre el cliente..."></textarea>
                        </div>
                        
                        <div style="margin-top: 30px; display: flex; gap: 15px; justify-content: flex-end;">
                            <button type="button" class="btn btn-secondary" onclick="cerrarModal()">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                💾 Guardar Lead
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>



            
    <script>
        // URL de tu Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycby7Aywyo1NMQf8Qnz54ulipvuNDftPC0HrKCFVupOIhqxS4nQcRB9Ib0TgVkQm8Hlg0/exec';
        
        // Variables globales
        let usuarioActual = null;
        let leadsData = [];
        let filtroActual = 'TODOS';

            // Datos de ejemplo como fallback
        const leadsEjemplo = {
            'jose-luis': [
                {
                    id: 'LEAD-001',
                    nombre: 'María Elena Vargas',
                    telefono: '0987654321',
                    email: 'maria.vargas@email.com',
                    monto: 3500,
                    estado: 'NUEVOS',
                    plan: 'PENDIENTE',
                    fechaCreacion: '2024-12-15'
                },
                {
                    id: 'LEAD-002',
                    nombre: 'Roberto Silva Torres',
                    telefono: '0976543210',
                    email: 'roberto.silva@email.com',
                    monto: 8500,
                    estado: 'CERRADOS',
                    plan: 'PLAN3',
                    fechaCreacion: '2024-12-10'
                }
            ],
            'ana-rodriguez': [
                {
                    id: 'LEAD-003',
                    nombre: 'Carlos Eduardo Mendoza',
                    telefono: '0965432109',
                    email: 'carlos.mendoza@email.com',
                    monto: 1500,
                    estado: 'INTERESADO',
                    plan: 'PLAN1',
                    fechaCreacion: '2024-12-12'
                }
            ],
            'carlos-mendez': [
                {
                    id: 'LEAD-004',
                    nombre: 'Ana Sofía Martínez',
                    telefono: '0943210987',
                    email: 'ana.martinez@email.com',
                    monto: 1200,
                    estado: 'GESTIONANDO',
                    plan: 'PLAN1',
                    fechaCreacion: '2024-12-14'
                }
            ]
        };

        // Función para obtener sesión del usuario
        function obtenerSesion() {
            try {
                const sesion = sessionStorage.getItem('sesionCRM');
                if (sesion) {
                    const sesionData = JSON.parse(sesion);
                    const ahora = new Date().getTime();
                    const tiempoSesion = sesionData.timestamp || 0;
                    if (ahora - tiempoSesion < 24 * 60 * 60 * 1000) {
                        return sesionData;
                    }
                }
            } catch (e) {
                console.log('SessionStorage no disponible');
            }
            return null;
        }

        
 // FUNCIÓN DEFINITIVA - FETCH DIRECTO SIN IFRAME
async function cargarLeadsDesdeAPI() {
    console.log('🔄 Cargando leads REALES desde Google Sheets...');
    console.log('👤 Usuario actual:', usuarioActual.usuario);
    
    // Mostrar estado de carga
    document.getElementById('leads-container').innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <h3>Cargando leads...</h3>
            <p>Conectando con Google Sheets...</p>
        </div>
    `;
    
    try {
        // Usar POST en lugar de GET para evitar CORS
        const formData = new FormData();
        formData.append('action', 'getLeads');
        formData.append('asesorId', usuarioActual.usuario);
        formData.append('empresaId', 'EMP001');
        
        console.log('📡 Enviando petición POST a Google Sheets...');
        
        const response = await fetch(API_URL, {
            method: 'POST',
            body: formData
        });
        
        console.log('📡 Respuesta recibida:', response.status);
        
        if (response.ok) {
            const text = await response.text();
            console.log('📡 Contenido de respuesta:', text.substring(0, 200) + '...');
            
            // Buscar JSON en la respuesta
            try {
                const jsonMatch = text.match(/\{.*\}/);
                if (jsonMatch) {
                    const result = JSON.parse(jsonMatch[0]);
                    if (result.success && result.data) {
                        leadsData = result.data;
                        console.log('✅ Leads REALES cargados:', leadsData.length);
                        
                        // Log de cada lead
                        leadsData.forEach((lead, index) => {
                            console.log(`📋 Lead ${index + 1}: ${lead.nombre} - ${lead.estado} - $${lead.monto?.toLocaleString() || 0}`);
                        });
                    }
                }
            } catch (e) {
                console.log('⚠️ No se encontró JSON válido, usando datos demo');
                // Datos demo mientras se establece la conexión
                leadsData = [
                    { id: 'LEAD001', nombre: 'Roberto Díaz', telefono: '987654321', email: 'roberto.diaz@email.com', monto: 150000, estado: 'NUEVOS', plan: 'COMERCIAL', asesor: 'jose-luis', fechaCreacion: '2025-05-31' },
                    { id: 'LEAD002', nombre: 'Laura Vásquez', telefono: '987654322', email: 'laura.vasquez@email.com', monto: 25000, estado: 'INTERESADO', plan: 'PERSONAL', asesor: 'jose-luis', fechaCreacion: '2025-05-31' }
                ];
            }
        } else {
            console.log('❌ Error en respuesta:', response.status);
            leadsData = [];
        }
        
    } catch (error) {
        console.log('❌ Error de conexión:', error);
        leadsData = [];
    }
    
    mostrarLeads();
    actualizarMetricas();
}
// FUNCIÓN PARA EDITAR LEAD - COMPLETA CON MODAL Y ENVÍO JSONP
function editarLead(leadId) {
    console.log('🔧 Editando lead:', leadId);
    
    // Buscar el lead en los datos actuales
    const lead = leadsData.find(l => l.id === leadId);
    if (!lead) {
        alert('❌ Lead no encontrado');
        return;
    }
    
    console.log('✅ Lead encontrado:', lead);
    
    // Llenar formulario con datos actuales
    document.getElementById('editar-id').value = lead.id || '';
    document.getElementById('editar-nombre').value = lead.nombre || '';
    document.getElementById('editar-telefono').value = lead.telefono || '';
    document.getElementById('editar-email').value = lead.email || '';
    document.getElementById('editar-monto').value = lead.monto || '';
    document.getElementById('editar-estado').value = lead.estado || 'PENDIENTE';
    document.getElementById('editar-plan').value = lead.plan || '';
    document.getElementById('editar-fecha-cita').value = lead.fechaCita || '';
    document.getElementById('editar-hora-cita').value = lead.horaCita || '';
    document.getElementById('editar-lugar-cita').value = lead.lugarCita || '';
    document.getElementById('editar-observaciones').value = lead.observaciones || '';
    
    // Mostrar modal
    document.getElementById('modalEditarLead').style.display = 'block';
    
    // REMOVER cualquier event listener anterior para evitar duplicados
    const formEditar = document.getElementById('formEditarLead');
    if (formEditar) {
        // Clonar el formulario para remover todos los event listeners
        const nuevoForm = formEditar.cloneNode(true);
        formEditar.parentNode.replaceChild(nuevoForm, formEditar);
        
        // Agregar el event listener JSONP que funciona
        nuevoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            console.log('✏️ NUEVO: Procesando edición de lead...');
            
            // Obtener datos del formulario
            const datosLead = {
                id: document.getElementById('editar-id').value,
                nombre: document.getElementById('editar-nombre').value.trim(),
                telefono: document.getElementById('editar-telefono').value.trim(),
                email: document.getElementById('editar-email').value.trim(),
                monto: document.getElementById('editar-monto').value,
                estado: document.getElementById('editar-estado').value,
                plan: document.getElementById('editar-plan').value,
                fechaCita: document.getElementById('editar-fecha-cita').value,
                horaCita: document.getElementById('editar-hora-cita').value,
                lugarCita: document.getElementById('editar-lugar-cita').value,
                observaciones: document.getElementById('editar-observaciones').value.trim()
            };
            
            console.log('📋 Datos de edición recopilados:', datosLead);
            
            // Validar campos requeridos
            if (!datosLead.nombre || !datosLead.telefono || !datosLead.monto) {
                alert('⚠️ Por favor complete todos los campos requeridos');
                return;
            }
            
            // Validar monto
            if (parseInt(datosLead.monto) < 1000) {
                alert('⚠️ El monto mínimo es $1,000');
                return;
            }
            
            console.log('✅ Datos validados, actualizando lead...');
            
            // USAR MÉTODO JSONP QUE FUNCIONA (exactamente como "Nuevo Lead")
            const callbackName = 'updateLead_' + Date.now();
            window[callbackName] = function(response) {
                console.log('📡 ¡RESPUESTA RECIBIDA!:', response);
                
                if (response && response.success) {
                    alert(`✅ ¡Lead actualizado exitosamente!\n\nCliente: ${datosLead.nombre}\nEstado: ${datosLead.estado}\nMonto: $${parseInt(datosLead.monto).toLocaleString()}`);
                    
                    // Cerrar modal
                    document.getElementById('modalEditarLead').style.display = 'none';
                    
                    // Recargar leads automáticamente
                    cargarLeadsDesdeAPI();
                } else {
                    alert(`❌ Error actualizando lead: ${response?.message || 'Error desconocido'}`);
                }
                
                // Limpiar callback
                delete window[callbackName];
            };
            
            // Construir parámetros JSONP exactamente como addLead
            const params = new URLSearchParams({
                action: 'updateLead',
                callback: callbackName,
                'ID_Lead': datosLead.id,
                'Nombre_Cliente': datosLead.nombre,
                'Email': datosLead.email || '',
                'Telefono': datosLead.telefono,
                'Tipo_Credito': datosLead.plan,
                'Monto_Solicitado': datosLead.monto,
                'Estado': datosLead.estado,
                'Asesor_ID': usuarioActual.usuario,
                'Fecha de la cita': datosLead.fechaCita || '',
                'Hora de la cita': datosLead.horaCita || '',
                'Lugar de la cita': datosLead.lugarCita || '',
                'Observaciones': datosLead.observaciones || ''
            });
            
            // Usar EXACTAMENTE el mismo método que "Nuevo Lead"
            const script = document.createElement('script');
            script.src = `${API_URL}?${params.toString()}`;
            document.head.appendChild(script);
            
            console.log('🎉 Solicitud JSONP enviada a:', API_URL);
            console.log('📝 Parámetros enviados:', params.toString());
        });
    }
}

// Función auxiliar para cerrar modal
function cerrarModalEditar() {
    document.getElementById('modalEditarLead').style.display = 'none';
}

// FUNCIÓN PARA GUARDAR CAMBIOS - USANDO MÉTODO QUE FUNCIONA (JSONP)
async function guardarEditLead(leadId) {
    console.log('💾 Guardando cambios para lead:', leadId);
    
    try {
        // Mostrar indicador de carga
        const saveButton = document.querySelector(`button[onclick="guardarEditLead('${leadId}')"]`);
        if (saveButton) {
            saveButton.innerHTML = '⏳ Guardando...';
            saveButton.disabled = true;
        }
        
        // Recoger datos del formulario (mismos campos que editarLead)
        const datosEditados = {
            id: leadId,
            nombre: document.getElementById('edit_nombre').value,
            telefono: document.getElementById('edit_telefono').value,
            email: document.getElementById('edit_email').value,
            monto: document.getElementById('edit_monto').value,
            estado: document.getElementById('edit_estado').value,
            plan: document.getElementById('edit_plan').value,
            fechaCita: document.getElementById('edit_fecha_cita') ? document.getElementById('edit_fecha_cita').value : '',
            horaCita: document.getElementById('edit_hora_cita') ? document.getElementById('edit_hora_cita').value : '',
            lugarCita: document.getElementById('edit_lugar_cita') ? document.getElementById('edit_lugar_cita').value : '',
            observaciones: document.getElementById('edit_observaciones').value
        };
        
        console.log('📝 Datos de edición:', datosEditados);
        
        // Validar campos requeridos
        if (!datosEditados.nombre || !datosEditados.telefono || !datosEditados.monto) {
            alert('⚠️ Por favor complete todos los campos requeridos');
            
            // Restaurar botón
            if (saveButton) {
                saveButton.innerHTML = '💾 Guardar Cambios';
                saveButton.disabled = false;
            }
            return;
        }
        
        // Validar monto
        if (parseInt(datosEditados.monto) < 1000) {
            alert('⚠️ El monto mínimo es $1,000');
            
            // Restaurar botón
            if (saveButton) {
                saveButton.innerHTML = '💾 Guardar Cambios';
                saveButton.disabled = false;
            }
            return;
        }
        
        console.log('✅ Datos validados, actualizando lead...');
        
        // Usar el MISMO método exitoso que guardarLeadEnGoogleSheets
        const exito = actualizarLeadEnGoogleSheets(datosEditados);
        
        if (exito) {
            console.log('🔄 Solicitud de actualización enviada...');
            // El callback manejará el éxito/error
        } else {
            // Restaurar botón en caso de error inmediato
            if (saveButton) {
                saveButton.innerHTML = '💾 Guardar Cambios';
                saveButton.disabled = false;
            }
            alert('❌ Error enviando actualización');
        }
        
    } catch (error) {
        console.log('❌ Error:', error);
        
        // Restaurar botón
        const saveButton = document.querySelector(`button[onclick="guardarEditLead('${leadId}')"]`);
        if (saveButton) {
            saveButton.innerHTML = '💾 Guardar Cambios';
            saveButton.disabled = false;
        }
        
        alert('❌ Error: ' + error.message);
    }
}

// FUNCIÓN REAL PARA ACTUALIZAR LEADS - USANDO MISMO MÉTODO QUE FUNCIONA
function actualizarLeadEnGoogleSheets(datosLead) {
    console.log('🔄 Actualizando lead REAL en Google Sheets...');
    
    // Crear callback único (mismo patrón que guardarLeadEnGoogleSheets)
    const callbackName = 'updateLead_' + Date.now();
    window[callbackName] = function(response) {
        console.log('📡 Respuesta actualizar:', response);
        
        // Restaurar botón
        const saveButton = document.querySelector(`button[onclick*="guardarEditLead"]`);
        if (saveButton) {
            saveButton.innerHTML = '💾 Guardar Cambios';
            saveButton.disabled = false;
        }
        
        if (response.success) {
            alert(`✅ ¡Lead actualizado exitosamente!\n\nCliente: ${datosLead.nombre}\nEstado: ${datosLead.estado}\nMonto: $${parseInt(datosLead.monto).toLocaleString()}`);
            
            // Cerrar modal de edición
            cerrarEditModal();
            
            // Recargar leads automáticamente
            console.log('🔄 Recargando leads desde Google Sheets...');
            cargarLeadsDesdeAPI();
        } else {
            alert(`❌ Error actualizando lead: ${response.message}`);
        }
        
        // Limpiar callback
        delete window[callbackName];
    };
    
    // Construir parámetros usando exactamente los mismos nombres que Google Apps Script espera
    const params = new URLSearchParams({
        action: 'updateLead',
        callback: callbackName,
        'ID_Lead': datosLead.id,
        'Nombre_Cliente': datosLead.nombre,
        'Email': datosLead.email || '',
        'Telefono': datosLead.telefono,
        'Tipo_Credito': datosLead.plan,
        'Monto_Solicitado': datosLead.monto,
        'Estado': datosLead.estado,
        'Asesor_ID': usuarioActual.usuario,
        'Fecha de la cita': datosLead.fechaCita || '',
        'Hora de la cita': datosLead.horaCita || '',
        'Lugar de la cita': datosLead.lugarCita || '',
        'Observaciones': datosLead.observaciones || ''
    });
    
    console.log('📡 Enviando actualización con parámetros:', Object.fromEntries(params));
    
    // Usar EXACTAMENTE el mismo método que funciona para agregar leads
    const script = document.createElement('script');
    script.src = `${API_URL}?${params.toString()}`;
    script.onerror = function() {
        console.log('❌ Error cargando script de actualización');
        
        // Restaurar botón
        const saveButton = document.querySelector(`button[onclick*="guardarEditLead"]`);
        if (saveButton) {
            saveButton.innerHTML = '💾 Guardar Cambios';
            saveButton.disabled = false;
        }
        
        alert('❌ Error de conexión al actualizar lead');
        delete window[callbackName];
    };
    
    document.head.appendChild(script);
    
    return true;
}  
  // Función para recargar leads manualmente
        function recargarLeads() {
            console.log('🔄 Recargando leads manualmente...');
            
            document.getElementById('leads-container').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <h3>Actualizando leads...</h3>
                    <p>Sincronizando con Google Sheets...</p>
                </div>
            `;
            
            cargarLeadsDesdeAPI();
        }

       // Función para mostrar leads - CON CAMPOS DE CITA
function mostrarLeads() {
    console.log('📋 Mostrando leads...');
    console.log('📊 Total leads:', leadsData.length);
    console.log('🔍 Filtro actual:', filtroActual);
    
    // DEBUG - Ver qué datos tenemos
    console.log('🔍 DEBUG - Primer lead completo:', leadsData[0]);
    if (leadsData[0]) {
        console.log('🔍 DEBUG - Campos de cita del primer lead:');
        console.log('  fechaCita:', leadsData[0].fechaCita);
        console.log('  horaCita:', leadsData[0].horaCita);  
        console.log('  lugarCita:', leadsData[0].lugarCita);
    }
    
    const container = document.getElementById('leads-container');
    
    if (!container) {
        console.error('❌ No se encontró el contenedor leads-container');
        return;
    }
    
    let leadsFiltrados = leadsData;
    if (filtroActual !== 'TODOS') {
        leadsFiltrados = leadsData.filter(lead => lead.estado === filtroActual);
        console.log('🔍 Leads filtrados:', leadsFiltrados.length);
    }
    if (leadsFiltrados.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 15px;">📋</div>
                <h3>No hay leads ${filtroActual === 'TODOS' ? '' : 'en estado ' + filtroActual}</h3>
                <p>¡Empieza agregando tu primer lead!</p>
            </div>
        `;
        return;
    }
    console.log('✅ Generando HTML para', leadsFiltrados.length, 'leads');
    
    const leadsHTML = leadsFiltrados.map((lead, index) => {
        console.log(`📋 Procesando lead ${index + 1}:`, lead.nombre);
        
        // DEBUG por lead individual
        if (index === 0) {
            console.log('🔍 DEBUG - Datos de cita del primer lead:');
            console.log('  fechaCita:', lead.fechaCita);
            console.log('  horaCita:', lead.horaCita);
            console.log('  lugarCita:', lead.lugarCita);
        }
        
        // Formatear fecha de cita
        let infoCita = '';
        if (lead.fechaCita || lead.horaCita || lead.lugarCita) {
            console.log('✅ Lead tiene datos de cita:', lead.nombre);
            const fechaFormateada = lead.fechaCita ? new Date(lead.fechaCita).toLocaleDateString('es-ES') : '';
            const horaFormateada = lead.horaCita || '';
            const lugarFormateado = lead.lugarCita || '';
            
            infoCita = `
                <div class="lead-cita" style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #007bff;">
                    ${fechaFormateada ? `📅 ${fechaFormateada}` : ''}
                    ${horaFormateada ? ` ⏰ ${horaFormateada}` : ''}
                    ${lugarFormateado ? `<br>📍 ${lugarFormateado}` : ''}
                </div>
            `;
        } else {
            console.log('❌ Lead SIN datos de cita:', lead.nombre);
        }
        
        return `
            <div class="lead-item">
                <div class="lead-info">
                    <div class="lead-name">${lead.nombre || 'Nombre no disponible'}</div>
                    <div class="lead-details">
                        📱 ${lead.telefono || 'Sin teléfono'} | 💰 ${(lead.monto || 0).toLocaleString()} | 💳 ${lead.plan || 'Sin plan'}
                    </div>
                    <div class="lead-meta">
                        <span>📅 Creado: ${lead.fechaCreacion ? new Date(lead.fechaCreacion).toLocaleDateString() : 'Sin fecha'}</span>
                        <span>📧 ${lead.email || 'Sin email'}</span>
                        ${lead.observaciones ? `<span>📝 ${lead.observaciones}</span>` : ''}
                    </div>
                    ${infoCita}
                </div>
                <div class="lead-actions">
                    <span class="status-badge status-${(lead.estado || 'pendiente').toLowerCase()}">${lead.estado || 'PENDIENTE'}</span>
                    <button class="action-btn" onclick="verDetalle('${lead.id}')">👁️ Ver</button>
                    <button class="action-btn" onclick="editarLead('${lead.id}')">✏️ Editar</button>
                </div>
            </div>
        `;
    }).join('');
    container.innerHTML = leadsHTML;
    console.log('✅ Leads mostrados en la interfaz');
}

        // Función para actualizar métricas
        function actualizarMetricas() {
            const estadosActivos = ['NUEVOS', 'INTERESADO', 'GESTIONANDO'];
            const activos = leadsData.filter(lead => estadosActivos.includes(lead.estado)).length;
            const cerrados = leadsData.filter(lead => lead.estado === 'CERRADOS').length;
            const pipeline = leadsData.filter(lead => estadosActivos.includes(lead.estado)).reduce((sum, lead) => sum + lead.monto, 0);
            const conversion = leadsData.length > 0 ? Math.round((cerrados / leadsData.length) * 100) : 0;

            document.getElementById('leads-activos').textContent = activos;
            document.getElementById('leads-cerrados').textContent = cerrados;
            document.getElementById('pipeline-total').textContent = `$${(pipeline/1000).toFixed(1)}K`;
            document.getElementById('tasa-conversion').textContent = `${conversion}%`;
        }

        // Función para filtrar leads
        function filtrarLeads(filtro) {
            filtroActual = filtro;
            
            // Actualizar botones activos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.trim() === filtro) {
                    btn.classList.add('active');
                }
            });

            mostrarLeads();
        }

        // Función para ver detalle
        function verDetalle(leadId) {
            const lead = leadsData.find(l => l.id === leadId);
            if (lead) {
                alert(`👤 DETALLE DEL LEAD\n\nNombre: ${lead.nombre}\nTeléfono: ${lead.telefono}\nEmail: ${lead.email}\nPlan: ${lead.plan}\nMonto: ${lead.monto.toLocaleString()}\nEstado: ${lead.estado}\nCreado: ${new Date(lead.fechaCreacion).toLocaleDateString()}`);
            }
        }

        // Función para editar lead
        function editarLead(leadId) {
            const lead = leadsData.find(l => l.id === leadId);
            if (!lead) {
                alert('Lead no encontrado');
                return;
            }
            
            console.log('✏️ Editando lead:', lead);
            
            // Llenar formulario con datos actuales
            document.getElementById('editar-id').value = lead.id;
            document.getElementById('editar-nombre').value = lead.nombre || '';
            document.getElementById('editar-telefono').value = lead.telefono || '';
            document.getElementById('editar-email').value = lead.email || '';
            document.getElementById('editar-monto').value = lead.monto || '';
            document.getElementById('editar-estado').value = lead.estado || '';
            document.getElementById('editar-plan').value = lead.plan || '';
            document.getElementById('editar-fecha-cita').value = lead.fechaCita || '';
            document.getElementById('editar-hora-cita').value = lead.horaCita || '';
            document.getElementById('editar-lugar-cita').value = lead.lugarCita || '';
            document.getElementById('editar-observaciones').value = lead.observaciones || '';
            
            // Mostrar modal
            document.getElementById('modalEditarLead').style.display = 'block';
        }

        // Función para cerrar modal de edición
        function cerrarModalEditar() {
            document.getElementById('modalEditarLead').style.display = 'none';
            
            // Limpiar formulario
            const form = document.getElementById('formEditarLead');
            if (form) {
                form.reset();
            }
        }

       // FUNCIÓN REAL PARA ACTUALIZAR LEADS
        function actualizarLeadEnGoogleSheets(datosLead) {
            console.log('🔄 Actualizando lead REAL en Google Sheets...');
            
            const callbackName = 'updateLead_' + Date.now();
            window[callbackName] = function(response) {
                console.log('📡 Respuesta actualizar:', response);
                
                if (response.success) {
                    alert(`✅ ¡Lead actualizado exitosamente!\n\nCliente: ${datosLead.nombre}`);
                    cerrarModalEditar();
                    // Recargar leads automáticamente
                    cargarLeadsDesdeAPI();
                } else {
                    alert(`❌ Error actualizando lead: ${response.message}`);
                }
                
                delete window[callbackName];
            };
            
            const params = new URLSearchParams({
                action: 'updateLead',
                callback: callbackName,
                'ID_Lead': datosLead.id,
                'Nombre_Cliente': datosLead.nombre,
                'Email': datosLead.email || '',
                'Telefono': datosLead.telefono,
                'Tipo_Credito': datosLead.plan,
                'Monto_Solicitado': datosLead.monto,
                'Estado': datosLead.estado,
                'Asesor_ID': usuarioActual.usuario,
                'Fecha de la cita': datosLead.fechaCita || '',
                'Hora de la cita': datosLead.horaCita || '',
                'Lugar de la cita': datosLead.lugarCita || '',
                'Observaciones': datosLead.observaciones || ''
            });
            
            const script = document.createElement('script');
            script.src = `${API_URL}?${params.toString()}`;
            document.head.appendChild(script);
            
            return true;
        }

        // Función para crear nuevo lead - CONECTA A GOOGLE SHEETS
        function crearNuevoLead() {
            console.log('📝 Abriendo modal para nuevo lead...');
            document.getElementById('modalNuevoLead').style.display = 'block';
        }

        // Función para cerrar modal
        function cerrarModal() {
            document.getElementById('modalNuevoLead').style.display = 'none';
            
            // Limpiar formulario
            const form = document.getElementById('formNuevoLead');
            if (form) {
                form.reset();
            }
        }

// FUNCIÓN GUARDAR LEAD - USANDO MISMA FUNCIÓN QUE EL BOTÓN
function guardarLeadEnGoogleSheets(datosLead) {
    console.log('💾 Guardando lead REAL en Google Sheets...');
    console.log('📋 Datos recopilados DIRECTAMENTE:', datosLead);
    
    // ENVÍO JSONP DIRECTO (MISMO PATRÓN QUE EDITAR)
    const callbackName = 'callback_' + Date.now();
    window[callbackName] = function(response) {
        console.log('📡 ¡RESPUESTA RECIBIDA!:', response);
        
        if (response && response.success) {
            alert(`✅ ¡Lead creado exitosamente!\n\nCliente: ${datosLead.nombre}`);
            cerrarModal();
            
            // USAR LA MISMA FUNCIÓN QUE EL BOTÓN "ACTUALIZAR"
            console.log('⚡ Usando recargarLeads() como el botón...');
            recargarLeads(); // ← ESTA ES LA CLAVE
            console.log('✅ Nuevo lead - Refresh completado con recargarLeads()');
            
        } else {
            alert(`❌ Error: ${response?.message || 'Error desconocido'}`);
        }
        
        delete window[callbackName];
    };
    
    // CONSTRUIR PARÁMETROS (MISMO FORMATO QUE EDITAR)
    const params = new URLSearchParams({
        action: 'addLead',
        callback: callbackName,
        'ID_Lead': 'LEAD-' + Date.now(),
        'Nombre_Cliente': datosLead.nombre,
        'Email': datosLead.email || '',
        'Telefono': datosLead.telefono,
        'Tipo_Credito': datosLead.plan,
        'Monto_Solicitado': datosLead.monto,
        'Estado': datosLead.estado,
        'Asesor_ID': usuarioActual.usuario,
        'Fecha de la cita': datosLead.fechaCita || '',
        'Hora de la cita': datosLead.horaCita || '',
        'Lugar de la cita': datosLead.lugarCita || '',
        'Observaciones': datosLead.observaciones || '',
        'Empresa_ID': 'EMP001'
    });
    
    // MISMO MÉTODO DE ENVÍO QUE EDITAR
    const script = document.createElement('script');
    script.src = `${API_URL}?${params.toString()}`;
    document.head.appendChild(script);
    
    console.log('🚀 JSONP ENVIADO DIRECTAMENTE');
    
    return true;
}
        // Función auxiliar para calcular probabilidad inicial basada en estado
        function calcularProbabilidadInicial(estado) {
            const probabilidades = {
                'NUEVOS': '15',
                'INTERESADO': '35', 
                'GESTIONANDO': '50',
                'CALIENTE': '80',
                'REAGENDO': '25',
                'PERDIDO': '0',
                'INCONTACTABLE': '0',
                'NO CONTESTA': '5',
                'VOLVER A LLAMAR': '20'
            };
            return probabilidades[estado] || '15';
        }

        // Función para cerrar sesión
        function cerrarSesion() {
            if (confirm('¿Está seguro que desea cerrar sesión?')) {
                sessionStorage.removeItem('sesionCRM');
                alert('Sesión cerrada. En producción redirigiría al login.');
                // Comentado para evitar 404: window.location.href = 'login.html';
                window.location.reload(); // Recargar la página en su lugar
            }
        }

        // ============================================
// CAMBIO 1: FUNCIÓN inicializarDashboard CORREGIDA
// ============================================
function inicializarDashboard() {
    console.log('🚀 Iniciando Dashboard Asesor...');
    
    const sesion = obtenerSesion();
    
    if (sesion && sesion.usuario && sesion.datos) {
        usuarioActual = sesion;
        
        // Verificar que NO sea gerente
        if (sesion.datos.tipo === 'GERENTE') {
            alert('Esta sección es para asesores. Seria redirigido al dashboard gerencial...');
            // Comentado para evitar error 404: window.location.href = 'dashboard-gerencial.html';
            return;
        }
        
        console.log(`👤 Asesor autenticado: ${sesion.usuario}`);
        
        // Actualizar header
        document.getElementById('welcome-message').textContent = `¡Bienvenido, ${sesion.datos.nombre.split(' ')[0]}!`;
        document.getElementById('user-name').textContent = sesion.datos.nombre;
        document.getElementById('user-role').textContent = `${sesion.datos.cargo} | ${sesion.datos.email}`;
        
        // Cargar datos
        cargarLeadsDesdeAPI();
        
    } else {
        console.log('❌ No hay sesión válida');
        console.log('🔄 Redirigiendo al login...');
        
        alert('Sesión expirada. Será redirigido al login.');
        window.location.href = 'index.html';
        return;
    }
}
// Event listener para formulario nuevo lead
document.addEventListener('DOMContentLoaded', function() {
    // Event listener para el formulario
    const form = document.getElementById('formNuevoLead');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            console.log('📝 Procesando nuevo lead...');
            
            // Obtener datos del formulario
            const datosLead = {
                nombre: document.getElementById('nuevo-nombre').value.trim(),
                telefono: document.getElementById('nuevo-telefono').value.trim(),
                email: document.getElementById('nuevo-email').value.trim(),
                monto: document.getElementById('nuevo-monto').value,
                estado: document.getElementById('nuevo-estado').value,
                plan: document.getElementById('nuevo-plan').value,
                fechaCita: document.getElementById('nuevo-fecha-cita').value,
                horaCita: document.getElementById('nuevo-hora-cita').value,
                lugarCita: document.getElementById('nuevo-lugar-cita').value,
                observaciones: document.getElementById('nuevo-observaciones').value.trim()
            };
            
            console.log('📋 Datos recopilados:', datosLead);
            
            // Validar campos requeridos
            if (!datosLead.nombre || !datosLead.telefono || !datosLead.monto) {
                alert('⚠️ Por favor complete todos los campos requeridos');
                return;
            }
            
            // Validar monto
            if (parseInt(datosLead.monto) < 1000) {
                alert('⚠️ El monto mínimo es $1,000');
                return;
            }
            
            console.log('✅ Datos validados, guardando lead...');
            
            // Guardar en Google Sheets - LA FUNCIÓN SE ENCARGA DE TODO
            guardarLeadEnGoogleSheets(datosLead);
        });
    }
    
    // Inicializar dashboard
    inicializarDashboard();
    
    // COMENTADO: Cerrar modal al hacer clic fuera
    /*
    window.onclick = function(event) {
        const modalNuevo = document.getElementById('modalNuevoLead');
        const modalEditar = document.getElementById('modalEditarLead');

        if (event.target === modalNuevo) {
            cerrarModal();
        }
        if (event.target === modalEditar) {
            cerrarModalEditar();
        }
    }
    */
});
        
// ============================================
// FUNCIÓN EDITAR LEAD - ULTRA RÁPIDA
// ============================================
function procesarEdicionLead() {
    console.log('🔥 BOTÓN CLICKEADO DIRECTAMENTE');
    
    const leadId = document.getElementById('editar-id').value;
    console.log('📋 Lead ID desde botón:', leadId);
    
    // OBTENER DATOS DIRECTAMENTE
    const datosLead = {
        id: leadId,
        nombre: document.getElementById('editar-nombre').value.trim(),
        telefono: document.getElementById('editar-telefono').value.trim(),
        email: document.getElementById('editar-email').value.trim(),
        monto: document.getElementById('editar-monto').value,
        estado: document.getElementById('editar-estado').value,
        plan: document.getElementById('editar-plan').value,
        fechaCita: document.getElementById('editar-fecha-cita').value,
        horaCita: document.getElementById('editar-hora-cita').value,
        lugarCita: document.getElementById('editar-lugar-cita').value,
        observaciones: document.getElementById('editar-observaciones').value.trim()
    };
    
    console.log('📋 Datos recopilados DIRECTAMENTE:', datosLead);
    
    // ENVÍO JSONP DIRECTO
    const callbackName = 'updateLead_' + Date.now();
    window[callbackName] = function(response) {
        console.log('📡 ¡RESPUESTA RECIBIDA!:', response);
        
        if (response && response.success) {
            alert(`✅ ¡Lead actualizado exitosamente!\n\nCliente: ${datosLead.nombre}`);
            document.getElementById('modalEditarLead').style.display = 'none';
            
            // REFRESH ULTRA RÁPIDO - INMEDIATO
            console.log('⚡ Refresh ultra rápido iniciando...');
            cargarLeadsDesdeAPI();
            actualizarMetricas();
            console.log('✅ Edición - Refresh completado inmediatamente');
            
        } else {
            alert(`❌ Error: ${response?.message || 'Error desconocido'}`);
        }
        
        delete window[callbackName];
    };
    
    const params = new URLSearchParams({
       action: 'updateLead',
    callback: callbackName,
    'ID_Lead': datosLead.id,
    'Nombre_Cliente': datosLead.nombre,
    'Email': datosLead.email || '',
    'Telefono': datosLead.telefono,
    'Tipo_Credito': datosLead.plan,
    'Monto_Solicitado': datosLead.monto,
    'Estado': datosLead.estado,
    'Asesor_ID': usuarioActual.usuario,
    'Fecha de la cita': datosLead.fechaCita || '',
    'Hora de la cita': datosLead.horaCita || '',
    'Lugar de la cita': datosLead.lugarCita || '',
    'Observaciones': datosLead.observaciones || ''
    });
    
    const script = document.createElement('script');
    script.src = `${API_URL}?${params.toString()}`;
    document.head.appendChild(script);
    
    console.log('🚀 JSONP ENVIADO DIRECTAMENTE');
}
        console.log('🚀 Dashboard Asesor cargado');
    </script>
</body>
</html>
